# 离线编译

着色器程序必须先被编译为一种可移植的字节码。接下来，图形驱动程序将获取这些字节码，并将其重新编译为针对当前系统 GPU 所优化的本地指令。

我们不仅可以在运行期间编译着色器，还能够以单独的步骤（例如，将其作为构建整个工程过程中 的一个独立环节，或是将其视为资源内容流水线（asset content
pipeline）流程的一部分）离线地（offline）编译着色器。这样做有原因若干：

1. 对于复杂的着色器来说，其编译过程可能耗时较长。因此，借助离线编译即可缩短应用程序的加载时间。
2. 以便在早于运行时的构建处理期间提前发现编译错误。
3. 对于 Windows 8 应用商店中的应用而言，必须采用离线编译这种方式。

我们通常用 `.cso` （即 compiled shader object，已编译的着色器对象）作为已编译着色器的扩展名。

为了以离线的方式编译着色器，我们将使用 DirectX 自带的 FXC 命令行编译工具。为了将 `color.hlsl` 文件中分别以 VS 和 PS 作为入口点的顶点着色器和像素着色器编译为**调试**版本的字节码，我们可以输入以下命令：

```shell
fxc "color.hlsl" /Od /Zi /T vs_5_0 /E "VS" /Fo "color_vs.cso" /Fc "color_vs.asm"
fxc "color.hlsl" /Od /Zi /T ps_5_0 /E "PS" /Fo "color_ps.cso" /Fc "color_ps.asm"
```

为了将 `color.hlsl` 文件中分别以 VS 和 PS 作为入口点的顶点着色器和像素着色器编译为**发行**版本的字节码，则可以输入以下命令：

```shell
fxc "color.hlsl" /T vs_5_0 /E "VS" /Fo "color_vs.cso" /Fc "color_vs.asm"
fxc "color.hlsl" /T ps_5_0 /E "PS" /Fo "color_ps.cso" /Fc "color_ps.asm" 
```

注：`Developer Powershell for VS 2022` 有相关的环境变量，可以直接使用 fxc。

| 参数             | 描述                                                |
|----------------|---------------------------------------------------|
| `/Od`          | 禁用优化（对于调试十分有用）                                    |
| `/Zi`          | 开启调试信息                                            |
| `/T <string>`  | 着色器类型和着色器模型的版本                                    |
| `/E <string>`  | 着色器入口点                                            |
| `/Fo <string>` | 经过编译的着色器对象字节码                                     |
| `/Fc <string>` | 输出一个着色器的汇编文件清单（对于调试、检验指令数量、<br/>查阅生成的代码细节都是很有帮助的） |

在编译期间及时获取错误信息要比在运行时才获得错误消息要便捷得多。 
